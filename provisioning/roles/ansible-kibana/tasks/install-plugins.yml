- name: Removing Plugins if they exist
  action: >
      shell bin/kibana plugin --remove {{ item.short }}
      chdir={{ kibana_dir }}
  with_items: "{{ kibana_plugins }}"
  ignore_errors: yes

- name: Installing Plugins by Name
  action: >
      shell bin/kibana plugin --install {{ item.name }}
      chdir={{ kibana_dir }}
  with_items: "{{ kibana_plugins }}"
  ignore_errors: yes
  environment: "{{ proxy_env }}"
  when: java_useproxy == 'false' or not java_useproxy


# Download Plugins if behind proxy
- name: Download Plugins
  get_url: >
    url={{ plugins_download_url }}/{{ item.path }}/{{ item.short }}-{{ item.version }}.tar.gz
    dest=/tmp/{{ item.short }}-{{ item.version }}.tar.gz
    validate_certs={{ validate_apt_certificates }}
  with_items: "{{ kibana_plugins }}"
  ignore_errors: yes
  environment: "{{ proxy_env }}"
  when: java_useproxy == 'true' or java_useproxy


- name: Installing Plugins by URL when using proxy
  action: >
      shell bin/kibana plugin --install {{ item.short }} --url file:///tmp/{{ item.short }}-{{ item.version }}.tar.gz
      chdir={{ kibana_dir }}
  with_items: "{{ kibana_plugins }}"
  ignore_errors: yes
  when: java_useproxy == 'true' or java_useproxy
